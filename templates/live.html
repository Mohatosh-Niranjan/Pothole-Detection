{% extends "base.html" %}
{% block title %}Live Feed - PotholeTrack{% endblock %}
{% block content %}
<div class="row">
  <div class="col-md-6">
    <div class="p-3 bg-white rounded shadow-sm mb-3">
      <h1 class="h5">Live Camera (Browser-side)</h1>
      <p class="text-muted small">
        This page uses your browser camera (getUserMedia). For full server-side detection on live frames, you would POST snapshots to a Flask endpoint.
      </p>
      <video id="liveVideo" autoplay playsinline class="w-100 border rounded"></video>
      <div class="mt-2">
        <button id="startBtn" class="btn btn-primary btn-sm">Start Camera</button>
        <button id="stopBtn" class="btn btn-outline-secondary btn-sm">Stop Camera</button>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="p-3 bg-white rounded shadow-sm mb-3">
      <h2 class="h5">Live Map</h2>
      <p class="text-muted small">Auto-refreshes every few seconds using detections from realtime database.</p>
      <iframe id="mapFrame" src="" width="100%" height="400" style="border:0;"></iframe>
    </div>
  </div>
</div>

<script>
  const video = document.getElementById('liveVideo');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');

  let mediaStream = null;

  async function startCamera() {
    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      video.srcObject = mediaStream;
    } catch (err) {
      alert('Error accessing camera: ' + err);
    }
  }

  function stopCamera() {
    if (mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
    }
  }

  startBtn.addEventListener('click', startCamera);
  stopBtn.addEventListener('click', stopCamera);

  // Simple live map refresh: use dashboard map html from outputs if desired
  function refreshMap() {
    // For now, just reload the iframe if a static map exists
    // In a full implementation, you can call /api/live_map and draw client-side
    fetch('/api/live_map').then(r => r.json()).then(data => {
      // You could render a client-side map here. For simplicity, if you have
      // a static map HTML generated, you could point the iframe to it.
      // Placeholder: no-op if no detections.
      if (data.length === 0) {
        return;
      }
    });
  }
  setInterval(refreshMap, 5000);
</script>
{% endblock %}


